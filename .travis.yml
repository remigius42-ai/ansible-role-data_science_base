---
language: python
python: "2.7"

sudo: required

os: linux

env:
  - DISTRIBUTION=Default
  - DISTRIBUTION=Debian
  - DISTRIBUTION=CentOS
  - DISTRIBUTION=Fedora

matrix:
  include:
    - os: osx
      language: generic
      env: PATCH_ANSIBLE_SYSTEM_FOR_OS_X="--extra-vars={\"ansible_system\":\"MacOSX\",\"data_science_base_anaconda_make_sys_default\":false}"

# Install Python and pip
before_install:
  - >-
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew update
      brew install python
      brew install md5sha1sum
      virtualenv venv -p python
      source venv/bin/activate
    fi
  - >-
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      sudo apt-get -qq update
      sudo apt-get install -qq python-pip
      pip install -q molecule docker-py
    fi

install:
  # Install ansible
  - pip install -q ansible

  # Check ansible version
  - ansible --version

script:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then molecule test --scenario-name $DISTRIBUTION; fi
  # Dirty hack to patch issue in anaconda role: ansible_system evaluates to Darwin
  #   instead of MacOSX and is overridden with --extra-vars to match the installer name.
  - echo $PATCH_ANSIBLE_SYSTEM_FOR_OS_X
  - >-
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      # Create ansible.cfg with correct roles_path
      printf '[defaults]\nroles_path=../' >ansible.cfg
      # Install dependencies (for syntax check and installation)
      ansible-galaxy install --roles-path ../ andrewrothstein.anaconda
      # Syntax check
      ansible-playbook tests/test.yml -i tests/inventory --syntax-check
      # Install role
      ansible-playbook tests/test.yml -i tests/inventory $PATCH_ANSIBLE_SYSTEM_FOR_OS_X;
    fi

notifications:
  webhooks: https://galaxy.ansible.com/api/v1/notifications/
